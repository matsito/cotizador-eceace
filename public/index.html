<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizador EceAce - Nube</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card { border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-radius: 10px; }
        .nav-tabs .nav-link { color: #495057; border: none; padding: 1rem 1.5rem; font-weight: 500; }
        .nav-tabs .nav-link.active { color: #0d6efd; border-bottom: 3px solid #0d6efd; background: transparent; }
        .badge-price-neto { background-color: #6c757d; }
        .badge-price-normal { background-color: #0dcaf0; color: #000; }
        .btn-circle { width: 32px; height: 32px; padding: 0; line-height: 32px; border-radius: 50%; text-align: center; }
        
        /* Animaci√≥n suave para las pesta√±as */
        .tab-pane { padding-top: 20px; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
    <div class="container">
        <a class="navbar-brand fw-bold" href="#">
            <i class="fas fa-bolt me-2"></i>Cotizador EceAce
        </a>
        <span class="badge bg-white text-primary px-3 py-2 rounded-pill" id="proyecto-activo-badge">
            <i class="fas fa-exclamation-circle me-1"></i>Sin Proyecto
        </span>
    </div>
</nav>

<div class="container mt-4">

    <ul class="nav nav-tabs bg-white rounded-top px-3 pt-2" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="inicio-tab" data-bs-toggle="tab" data-bs-target="#inicio" type="button" role="tab">
                <i class="fas fa-home me-2"></i>Inicio & Configuraci√≥n
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="cotizador-tab" data-bs-toggle="tab" data-bs-target="#cotizador" type="button" role="tab">
                <i class="fas fa-calculator me-2"></i>Cotizador
            </button>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">
        
        <div class="tab-pane fade show active" id="inicio" role="tabpanel">
            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="card h-100">
                        <div class="card-header bg-white border-bottom-0 pt-4 px-4">
                            <h5 class="card-title text-primary"><i class="fas fa-file-signature me-2"></i>Datos del Nuevo Proyecto</h5>
                        </div>
                        <div class="card-body px-4 pb-4">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small text-muted">Nombre Proyecto</label>
                                    <input type="text" id="nombreProyecto" class="form-control form-control-lg" placeholder="Ej: Tablero Sala El√©ctrica">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold small text-muted">Cliente</label>
                                    <input type="text" id="cliente" class="form-control form-control-lg" placeholder="Ej: Arauco">
                                </div>
                                
                                <div class="col-12"><hr class="text-muted my-2"></div>

                                <div class="col-md-3">
                                    <label class="form-label small text-muted">Valor D√≠a M.O.</label>
                                    <input type="number" id="valorDia" class="form-control" value="80000" onchange="calcularTotales()">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small text-muted">D√≠as</label>
                                    <input type="number" id="diasTrab" class="form-control" value="1" onchange="calcularTotales()">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small text-muted">Personas</label>
                                    <input type="number" id="cantPersonas" class="form-control" value="1" onchange="calcularTotales()">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small text-muted">Margen %</label>
                                    <input type="number" id="margenGeneral" class="form-control" value="30" onchange="calcularTotales()">
                                </div>

                                <div class="col-12 mt-4">
                                    <button class="btn btn-primary w-100 btn-lg shadow-sm" onclick="crearProyecto()">
                                        <i class="fas fa-save me-2"></i>Guardar y Comenzar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card bg-light h-100 border-warning border-top border-3">
                        <div class="card-body text-center p-4">
                            <div class="mb-3 text-warning">
                                <i class="fas fa-file-excel fa-3x"></i>
                            </div>
                            <h6 class="card-title fw-bold">Actualizar Inventario</h6>
                            <p class="card-text small text-muted">Si tienes productos nuevos, sube tu Excel aqu√≠.</p>
                            <input type="file" id="archivoExcel" class="form-control form-control-sm mb-3" accept=".xlsx, .xls">
                            <button class="btn btn-warning w-100 text-dark fw-bold" onclick="subirExcel()">
                                <i class="fas fa-upload me-2"></i>Importar
                            </button>
                        </div>
                    </div>
                </div>
            
            </div>
        
        </div>

        <div class="tab-pane fade" id="cotizador" role="tabpanel">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-white py-3">
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0"><i class="fas fa-search text-muted"></i></span>
                                <input type="text" id="buscador" class="form-control border-start-0 ps-0" placeholder="Buscar material..." onkeyup="buscarMateriales()">
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <ul class="list-group list-group-flush" id="lista-materiales" style="max-height: 500px; overflow-y: auto;">
                                <li class="list-group-item text-muted text-center py-5">
                                    <i class="fas fa-arrow-up mb-2"></i><br>Escribe arriba para buscar
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center py-3">
                            <h6 class="mb-0"><i class="fas fa-list-alt me-2"></i>Detalle de la Cotizaci√≥n</h6>
                            <small class="text-warning" id="nombre-proyecto-tabla">Sin nombre</small>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="ps-3">Item</th>
                                            <th style="width: 80px;">Cant.</th>
                                            <th class="text-end">Unitario</th>
                                            <th class="text-end">Total</th>
                                            <th style="width: 50px;"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="tabla-items">
                                        </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div class="card-footer bg-white border-top p-4">
                            <div class="row text-end justify-content-end">
                                <div class="col-md-6">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted">Materiales:</span>
                                        <span class="fw-bold" id="total-materiales">$0</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-1">
                                        <span class="text-muted">Mano de Obra:</span>
                                        <span class="fw-bold" id="total-mo">$0</span>
                                    </div>
                                    <div class="d-flex justify-content-between mb-2 text-primary">
                                        <span>+ Margen (<span id="lbl-margen">30</span>%):</span>
                                        <span class="fw-bold" id="total-margen">$0</span>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="h5 mb-0 text-success">TOTAL NETO:</span>
                                        <span class="h3 mb-0 text-success fw-bold" id="gran-total">$0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div> </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let cotizacionIdActual = null;
    let itemsCotizacion = [];

    // --- FUNCIONES ---

    async function crearProyecto() {
        const nombre = document.getElementById('nombreProyecto').value;
        const cliente = document.getElementById('cliente').value;
        const valorDia = document.getElementById('valorDia').value;
        const dias = document.getElementById('diasTrab').value;
        const personas = document.getElementById('cantPersonas').value;
        const margen = document.getElementById('margenGeneral').value;

        if(!nombre) return alert("‚ö†Ô∏è Ponle un nombre al proyecto.");

        try {
            const res = await fetch('/api/cotizaciones', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    nombre_proyecto: nombre, 
                    cliente, 
                    valor_dia_mo: valorDia,
                    dias_trabajados: dias,
                    cantidad_personas: personas,
                    margen_general: margen
                })
            });
            const data = await res.json();
            cotizacionIdActual = data.id;
            
            // Actualizar interfaz visualmente
            document.getElementById('proyecto-activo-badge').innerHTML = `<i class="fas fa-check-circle me-1"></i>${nombre}`;
            document.getElementById('proyecto-activo-badge').className = "badge bg-success px-3 py-2 rounded-pill";
            document.getElementById('nombre-proyecto-tabla').textContent = nombre;

            // Cambiar autom√°ticamente a la pesta√±a del cotizador
            const tabCotizador = new bootstrap.Tab(document.querySelector('#cotizador-tab'));
            tabCotizador.show();

            alert("‚úÖ Proyecto creado. ¬°Empieza a agregar materiales!");
        } catch (e) {
            console.error(e);
            alert("Error al crear proyecto");
        }
    }


    async function buscarMateriales() {
        const query = document.getElementById('buscador').value;
        if(query.length < 2) return;

        const res = await fetch(`/api/materiales?q=${query}`);
        const lista = await res.json();
        renderMateriales(lista);
    }


    function renderMateriales(lista) {
        const listaEl = document.getElementById('lista-materiales');
        listaEl.innerHTML = '';

        if(lista.length === 0) {
            listaEl.innerHTML = '<li class="list-group-item text-center text-muted">No encontr√© nada ü§∑‚Äç‚ôÇÔ∏è</li>';
            return;
        }

        lista.forEach(mat => {
            const li = document.createElement('li');
            li.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center p-3';
            

            li.innerHTML = `
                <div>
                    <h6 class="mb-0 text-dark fw-bold">${mat.nombre}</h6>
                    <small class="text-muted d-block">Marca: ${mat.marca || 'Gen√©rico'} | Unidad: ${mat.unidad}</small>
                </div>
                <div class="text-end">
                    <div class="mb-1">
                        <span class="badge badge-price-neto me-1" title="Precio Neto">N: $${mat.valor_int.toLocaleString()}</span>
                        <span class="badge badge-price-normal" title="Precio Normal">P: $${mat.valor_normal ? mat.valor_normal.toLocaleString() : '0'}</span>
                    </div>
                    <button class="btn btn-outline-primary btn-sm rounded-pill px-3" onclick="agregarItem(${mat.id}, '${mat.nombre}', ${mat.valor_int})">
                        Agregar <i class="fas fa-plus ms-1"></i>
                    </button>
                </div>
            `;
            listaEl.appendChild(li);
        });
    }


    async function agregarItem(materialId, nombre, precio) {
        if(!cotizacionIdActual) {
            alert("‚ö†Ô∏è ¬°Primero crea el proyecto en la pesta√±a 'Inicio'!");
            // Volver a la pesta√±a inicio si se equivoc√≥
            const tabInicio = new bootstrap.Tab(document.querySelector('#inicio-tab'));
            tabInicio.show();
            return;
        }

        await fetch('/api/items', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                cotizacion_id: cotizacionIdActual,
                material_id: materialId,
                cantidad: 1,
                precio_congelado: precio
            })
        });

        const item = { id: Date.now(), nombre, precio, cantidad: 1 };
        itemsCotizacion.push(item);
        renderTabla();
        calcularTotales();
    }


    function renderTabla() {
        const tbody = document.getElementById('tabla-items');
        tbody.innerHTML = '';

        itemsCotizacion.forEach((item, index) => {
            const total = item.cantidad * item.precio;
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="ps-3">${item.nombre}</td>
                <td><input type="number" class="form-control form-control-sm text-center" value="${item.cantidad}" onchange="actualizarCantidad(${index}, this.value)" min="1"></td>
                <td class="text-end">$${item.precio.toLocaleString()}</td>
                <td class="text-end fw-bold">$${total.toLocaleString()}</td>
                <td class="text-center"><button class="btn btn-link text-danger btn-circle" onclick="eliminarItem(${index})"><i class="fas fa-times"></i></button></td>
            `;
            tbody.appendChild(tr);
        });
    }

    function actualizarCantidad(index, cant) {
        itemsCotizacion[index].cantidad = Number(cant);
        renderTabla();
        calcularTotales();
    }

    function eliminarItem(index) {
        itemsCotizacion.splice(index, 1);
        renderTabla();
        calcularTotales();
    }


    function calcularTotales() {

        let subtotalMateriales = itemsCotizacion.reduce((sum, item) => sum + (item.cantidad * item.precio), 0);
        

        const valorDia = Number(document.getElementById('valorDia').value) || 0;
        const dias = Number(document.getElementById('diasTrab').value) || 0;
        const personas = Number(document.getElementById('cantPersonas').value) || 0;
        const costoMO = valorDia * dias * personas;


        const margenPorcentaje = Number(document.getElementById('margenGeneral').value) || 0;
        const costoTotal = subtotalMateriales + costoMO;
        const valorMargen = costoTotal * (margenPorcentaje / 100);


        const granTotal = costoTotal + valorMargen;


        document.getElementById('total-materiales').innerText = `$${subtotalMateriales.toLocaleString()}`;
        document.getElementById('total-mo').innerText = `$${costoMO.toLocaleString()}`;
        document.getElementById('lbl-margen').innerText = margenPorcentaje;
        document.getElementById('total-margen').innerText = `$${Math.round(valorMargen).toLocaleString()}`;
        document.getElementById('gran-total').innerText = `$${Math.round(granTotal).toLocaleString()}`;
    }


    async function subirExcel() {
        const input = document.getElementById('archivoExcel');
        if(!input.files[0]) return alert("Selecciona un archivo");

        const formData = new FormData();
        formData.append('file', input.files[0]);

        try {
            const res = await fetch('/api/upload-excel', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            alert(data.message);
        } catch (error) {
            console.error(error);
            alert("Error al subir excel");
        }
    }
</script>

</body>
</html>